<!DOCTYPE html><html><head><title>DoobieRoll: Assembler</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jacob Wang" /><meta name="description" content="Collection of utilities for working with Doobie/SQL" /><meta name="og:image" content="/doobieroll/img/poster.png" /><meta name="image" property="og:image" content="/doobieroll/img/poster.png" /><meta name="og:title" content="DoobieRoll: Assembler" /><meta name="title" property="og:title" content="DoobieRoll: Assembler" /><meta name="og:site_name" content="DoobieRoll" /><meta name="og:url" content="https://github.com/jatcwang/doobieroll" /><meta name="og:type" content="website" /><meta name="og:description" content="Collection of utilities for working with Doobie/SQL" /><link rel="icon" type="image/png" href="/doobieroll/img/favicon.png" /><meta name="twitter:title" content="DoobieRoll: Assembler" /><meta name="twitter:image" content="https://jatcwang.github.io/doobieroll/img/poster.png" /><meta name="twitter:description" content="Collection of utilities for working with Doobie/SQL" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobieroll/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobieroll/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobieroll/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobieroll/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobieroll/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobieroll/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobieroll/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobieroll/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobieroll/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobieroll/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobieroll/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobieroll/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobieroll/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobieroll/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobieroll/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobieroll/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobieroll/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobieroll/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobieroll/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobieroll/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobieroll/highlight/styles/a11y-light.css" /><link rel="stylesheet" href="/doobieroll/css/light-style.css" /><link rel="stylesheet" href="/doobieroll/css/main.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/doobieroll/" class="brand"><div class="brand-wrapper"></div><span>DoobieRoll</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item active "><a href="/doobieroll/docs/assembler" title="Assembler" class="active">Assembler</a></div> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/tablecolumns" title="TableColumns" class="">TableColumns</a></div> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/snippets" title="Snippets" class="">Snippets</a></div> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/faq" title="FAQ" class="">FAQ</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/jatcwang/doobieroll" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/jatcwang/doobieroll" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="jatcwang" data-github-repo="doobieroll"><div class="content-wrapper"><section><h1 id="assembler">Assembler</h1>

<h2 id="motivation---what-problem-does-it-solve">Motivation - What problem does it solve?</h2>

<p>Assembler helps “assemble” relational data into their corresponding hierarchical representation.</p>

<p>When querying a relational database, the query result are often not immediately usable for our business logic nor API response
because our domain models are often hierarchical.</p>

<p>To use an example, DoobieRoll assemblers can help you transform results of a SQL JOIN query like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT company_id, company_name, department_id, department_name, employee_id, employee_name
FROM company
INNER JOIN department ON department.company_id = company.id
INNER JOIN employee ON employee.department_id = department.id
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>company_id</th>
      <th>company_name</th>
      <th>department_id</th>
      <th>department_name</th>
      <th>employee_id</th>
      <th>employee_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>comp_id_1</td>
      <td>Comp 1</td>
      <td>dep_id_1</td>
      <td>Dep 1</td>
      <td>emp_id_1</td>
      <td>Alice</td>
    </tr>
    <tr>
      <td>comp_id_1</td>
      <td>Comp 1</td>
      <td>dep_id_1</td>
      <td>Dep 1</td>
      <td>emp_id_2</td>
      <td>Bob</td>
    </tr>
    <tr>
      <td>comp_id_2</td>
      <td>Comp 2</td>
      <td>dep_id_2</td>
      <td>Dep 2</td>
      <td>emp_id_3</td>
      <td>John</td>
    </tr>
    <tr>
      <td>comp_id_2</td>
      <td>Comp 2</td>
      <td>dep_id_2</td>
      <td>Dep 3</td>
      <td>emp_id_4</td>
      <td>Nicole</td>
    </tr>
  </tbody>
</table>

<p>Into this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">List</span><span class="o">(</span>
    <span class="nc">Company</span><span class="o">(</span>
      <span class="n">id</span> <span class="k">=</span> <span class="s">"comp_id_1"</span><span class="o">,</span>
      <span class="n">name</span> <span class="k">=</span> <span class="s">"Comp 1"</span><span class="o">,</span>
      <span class="n">departments</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
        <span class="nc">Department</span><span class="o">(</span>
          <span class="n">id</span> <span class="k">=</span> <span class="s">"dep_id_1"</span><span class="o">,</span>
          <span class="n">name</span> <span class="k">=</span> <span class="s">"Dep1"</span><span class="o">,</span>
          <span class="n">employees</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
            <span class="nc">Employee</span><span class="o">(</span>
              <span class="n">id</span> <span class="k">=</span> <span class="s">"emp_id_1"</span><span class="o">,</span>
              <span class="n">name</span> <span class="k">=</span> <span class="s">"Alice"</span><span class="o">,</span>
            <span class="o">),</span>
            <span class="nc">Employee</span><span class="o">(</span>
              <span class="n">id</span> <span class="k">=</span> <span class="s">"emp_id_2"</span><span class="o">,</span>
              <span class="n">name</span> <span class="k">=</span> <span class="s">"Bob"</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="n">id</span> <span class="k">=</span> <span class="s">"comp_id_2"</span><span class="o">,</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">"Comp 2"</span><span class="o">,</span>
    <span class="n">departments</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
      <span class="nc">Department</span><span class="o">(</span>
        <span class="n">id</span> <span class="k">=</span> <span class="s">"dep_id_2"</span><span class="o">,</span>
        <span class="n">name</span> <span class="k">=</span> <span class="s">"Dep2"</span><span class="o">,</span>
        <span class="n">employees</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
          <span class="nc">Employee</span><span class="o">(</span>
            <span class="n">id</span> <span class="k">=</span> <span class="s">"emp_id_3"</span><span class="o">,</span>
            <span class="n">name</span> <span class="k">=</span> <span class="s">"John"</span><span class="o">,</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="nc">Department</span><span class="o">(</span>
        <span class="n">id</span> <span class="k">=</span> <span class="s">"dep_id_3"</span><span class="o">,</span>
        <span class="n">name</span> <span class="k">=</span> <span class="s">"Dep3"</span><span class="o">,</span>
        <span class="n">employees</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
          <span class="nc">Employee</span><span class="o">(</span>
            <span class="n">id</span> <span class="k">=</span> <span class="s">"emp_id_4"</span><span class="o">,</span>
            <span class="n">name</span> <span class="k">=</span> <span class="s">"Nicole"</span><span class="o">,</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">)</span>
</code></pre></div></div>

<p>With doobie, typically the columns in the result set are grouped into logical groups which roughly maps to domain models. 
Using the example query above, the type of a doobie query will be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>List[DbCompany :: DbDepartment :: DbEmployee :: HNil]
</code></pre></div></div>

<p>(The type above is isomorphic to <code class="language-plaintext highlighter-rouge">List[(DbCompany, DbDepartment, DbEmployee))]</code>. 
Assembler works directly shapeless’s HList instead of tuples, though it’s easy to convert between them. 
I suggest <a href="https://books.underscore.io/shapeless-guide/shapeless-guide.html#generic-product-encodings">reading about it</a> 
to get a basic understand of what they represent before you continue)</p>

<p>Each field in these DB model case classes map to a column in the query result:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>case class DbCompany(
  id: String,
  name: String
)

case class DbDepartment(
  id: String,
  name: String
)

case class DbEmployee(
  id: String,
  name: String
)
</code></pre></div></div>

<p>To convert this to a <code class="language-plaintext highlighter-rouge">List[Company]</code>, we often use <code class="language-plaintext highlighter-rouge">.groupBy</code>s on the ids (in this case on <code class="language-plaintext highlighter-rouge">company.id</code> and <code class="language-plaintext highlighter-rouge">department.id</code>).
We’d group employees belonging to the same department/company together and then convert each group into their domain model.</p>

<p>There are however some downsides to this approach:</p>

<ul>
  <li>Code is difficult to reuse - You’d have to write the same transformation for every different query you have</li>
  <li>The logic becomes more complex when
    <ul>
      <li>The conversion from the database model (<code class="language-plaintext highlighter-rouge">DbDepartment</code>) to your domain model (<code class="language-plaintext highlighter-rouge">Department</code>) can fail.</li>
      <li>You object relationships are more complex, where a parent class can have multiple children types 
(which in turn can have their own children types)</li>
    </ul>
  </li>
</ul>

<p>Assembler solves this problem by only requiring you to declare your data relationships, and it’ll take care of 
the assembling for you!</p>

<h1 id="using-assembler">Using Assembler</h1>

<p>Here are the main steps to use Assembler:</p>

<ol>
  <li><strong>Define the database-to-domain relationship</strong> - Define how to convert each database to their corresponding domain model.</li>
  <li><strong>Create the Assembler</strong> using these definitions</li>
  <li><strong>Assemble your query result</strong> - Feed the database query results into the assembler to get your domain objects</li>
</ol>

<p>Let’s see how it’s actually done with an example:</p>

<ul>
  <li>A <strong>Town</strong> can have many <strong>Schools</strong> (one-to-many relationship)</li>
  <li>A <strong>School</strong> can have many <strong>Students</strong> (one-to-many relationship)</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Town</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">schools</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">School</span><span class="o">]</span>
<span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">School</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">students</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Student</span><span class="o">]</span>
<span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Student</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre></div></div>

<p>Let’s say we want to find towns, with the schools in those towns and the students in each of those schools.
The code you’ll write with doobie to retrieve this information will probably look like</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.implicits._</span> 
<span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{::,</span> <span class="nc">HNil</span><span class="o">}</span>

<span class="k">val</span> <span class="nv">townsQuery</span> <span class="k">=</span> <span class="n">fr</span><span class="s">"""
SELECT town.id, town.name, school.id, school.name, student.id, student.name 
FROM town
INNER JOIN school ON school.town_id = town.id
INNER JOIN student ON student.school_id = school.id
WHERE town.name LIKE '%ville'
"""</span><span class="o">.</span><span class="py">query</span><span class="o">[</span><span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>

<span class="c1">// Our database models</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DbTown</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DbSchool</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DbStudent</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre></div></div>

<p>and after running the query against some data you’ll have a result list.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">queryResult</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> <span class="c1">// ...code to run the SQL query here omitted</span>
</code></pre></div></div>

<h3 id="1-define-the-database-to-domain-relationship">1. Define the database-to-domain relationship</h3>

<p>When assembling domain models, they can be split into two types:</p>

<ul>
  <li><strong>Leaf</strong>: Types without any children (e.g. <code class="language-plaintext highlighter-rouge">Student</code>)</li>
  <li><strong>Parent</strong>: Types with one or more children types, (e.g. <code class="language-plaintext highlighter-rouge">Town</code> has <code class="language-plaintext highlighter-rouge">School</code> as children, and <code class="language-plaintext highlighter-rouge">School</code> has <code class="language-plaintext highlighter-rouge">Stdudent</code> as children)</li>
</ul>

<p>Let’s define our relationships</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.Id</span>
<span class="k">import</span> <span class="nn">doobieroll._</span>
<span class="k">import</span> <span class="nn">doobieroll.implicits._</span>

<span class="k">val</span> <span class="nv">townDef</span><span class="k">:</span> <span class="kt">ParentDef.Aux</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">Town</span>, <span class="kt">DbTown</span>, <span class="kt">School</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ParentDef</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
  <span class="n">getId</span> <span class="k">=</span> <span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DbTown</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">d</span><span class="o">.</span><span class="py">id</span><span class="o">,</span>
  <span class="n">constructWithChild</span> <span class="k">=</span> <span class="o">(</span><span class="n">db</span><span class="k">:</span> <span class="kt">DbTown</span><span class="o">,</span> <span class="n">schools</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">School</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">Town</span><span class="o">(</span><span class="nv">db</span><span class="o">.</span><span class="py">id</span><span class="o">,</span> <span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">,</span> <span class="n">schools</span><span class="o">)</span>
<span class="o">)</span>

<span class="k">val</span> <span class="nv">schoolDef</span><span class="k">:</span> <span class="kt">ParentDef.Aux</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">School</span>, <span class="kt">DbSchool</span>, <span class="kt">Student</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ParentDef</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
  <span class="n">getId</span> <span class="k">=</span> <span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DbSchool</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">d</span><span class="o">.</span><span class="py">id</span><span class="o">,</span>
  <span class="n">constructWithChild</span> <span class="k">=</span> <span class="o">(</span><span class="n">db</span><span class="k">:</span> <span class="kt">DbSchool</span><span class="o">,</span> <span class="n">students</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Student</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">School</span><span class="o">(</span><span class="nv">db</span><span class="o">.</span><span class="py">id</span><span class="o">,</span> <span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">,</span> <span class="n">students</span><span class="o">)</span>
<span class="o">)</span>

<span class="k">val</span> <span class="nv">studentDef</span><span class="k">:</span> <span class="kt">LeafDef</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">Student</span>, <span class="kt">DbStudent</span><span class="o">]</span> <span class="k">=</span> <span class="nv">LeafDef</span><span class="o">.</span><span class="py">make</span><span class="o">(</span>
  <span class="o">(</span><span class="n">db</span><span class="k">:</span> <span class="kt">DbStudent</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Student</span><span class="o">(</span><span class="nv">db</span><span class="o">.</span><span class="py">id</span><span class="o">,</span> <span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">)</span>
<span class="o">)</span>
</code></pre></div></div>

<h3 id="2-create-the-assembler">2. Create the Assembler</h3>

<p>With our individual definitions, we can now build an <strong>Assembler</strong></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">assembler</span><span class="k">:</span> <span class="kt">ParentAssembler</span><span class="o">[</span><span class="kt">cats.Id</span>, <span class="kt">Town</span>, <span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> 
  <span class="nv">townDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">(</span><span class="nv">schoolDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">(</span><span class="nv">studentDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">))</span>
</code></pre></div></div>

<p>The signature of the assembler tells us that it knows how to construct some <code class="language-plaintext highlighter-rouge">Town</code>s from a 
list of query result rows! (<code class="language-plaintext highlighter-rouge">DbTown :: DbSchool :: DbStudent :: HNil</code>).
(Note how the DB type of assembler and the query result from above matches!)</p>

<h3 id="3-assemble-your-query-result">3. Assemble your query result</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">towns</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Town</span><span class="o">]</span> <span class="k">=</span> <span class="nv">assembler</span><span class="o">.</span><span class="py">assemble</span><span class="o">(</span><span class="n">queryResult</span><span class="o">)</span>
<span class="c1">// towns: Vector[Town] = Vector(</span>
<span class="c1">//   Town(</span>
<span class="c1">//     bca65379-1e46-40ca-bff5-5ca96c5fd183,</span>
<span class="c1">//     "Smallville",</span>
<span class="c1">//     Vector(</span>
<span class="c1">//       School(</span>
<span class="c1">//         c60e0a80-cfcb-4578-b00d-14b3fe68e734,</span>
<span class="c1">//         "Smallville High",</span>
<span class="c1">//         Vector(</span>
<span class="c1">//           Student(d948735b-1173-411c-ac00-e019ee89897a, "Clark"),</span>
<span class="c1">//           Student(7158132d-fe59-4ef1-8693-1476a0359aa7, "Bob")</span>
<span class="c1">//         )</span>
<span class="c1">//       )</span>
<span class="c1">//     )</span>
<span class="c1">//   ),</span>
<span class="c1">//   Town(</span>
<span class="c1">//     ee58ad86-ce81-4650-b329-b701424fc23b,</span>
<span class="c1">//     "Springfield",</span>
<span class="c1">//     Vector(</span>
<span class="c1">//       School(</span>
<span class="c1">//         51f02985-db87-4350-b557-6d9476e1367f,</span>
<span class="c1">//         "Springfield Elementary School",</span>
<span class="c1">//         Vector(</span>
<span class="c1">//           Student(4386ad3e-a30c-4179-938f-a0ead5bd9b4a, "Lisa"),</span>
<span class="c1">//           Student(997c0f4b-106d-4d80-82bd-02bae0a2c177, "Bart")</span>
<span class="c1">//         )</span>
<span class="c1">//       )</span>
<span class="c1">//     )</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>That’s it!</p>

<h3 id="4-usage-with-doobie-and-any-other-sources-of-data">4. Usage with Doobie (and any other sources of data)</h3>

<p>The Assembler typeclass <code class="language-plaintext highlighter-rouge">assemble</code> can take any input data that resembles a list of HList.</p>

<p>When querying with Doobie, you can query directly into an HList and then pipe the output 
straight through Assembler.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">doobie.</span><span class="o">{</span><span class="nc">ConnectionIO</span><span class="o">,</span> <span class="nc">Transactor</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>

<span class="c1">// Your SQL query to perform</span>
<span class="c1">// (...however you create your Doobie transactor)</span>
<span class="k">val</span> <span class="nv">transactor</span><span class="k">:</span> <span class="kt">Transactor</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>  

<span class="k">val</span> <span class="nv">query</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]]</span> <span class="k">=</span> 
  <span class="n">fr</span><span class="s">"""
    |SELECT school.id, school.name, teacher.id, teacher.name, student.name
    |FROM school
    |LEFT JOIN teacher WHERE teacher.school_id = school.id
    |LEFT JOIN student WHERE student.school_id = school.id
  """</span>
    <span class="o">.</span><span class="py">stripMargin</span>
    <span class="o">.</span><span class="py">query</span><span class="o">[</span><span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>
    <span class="o">.</span><span class="py">to</span><span class="o">[</span><span class="kt">Vector</span><span class="o">]</span>
    
<span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Town</span><span class="o">]]</span> <span class="k">=</span> <span class="nv">query</span><span class="o">.</span><span class="py">transact</span><span class="o">(</span><span class="n">transactor</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">queryResult</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">DbTown</span> <span class="kt">::</span> <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=&gt;</span>
  <span class="nv">assembler</span><span class="o">.</span><span class="py">assemble</span><span class="o">(</span><span class="n">queryResult</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="usage-notes">Usage notes</h1>

<h3 id="row-identity">Row identity</h3>
<p>When joining sibling tables, SQL engines will often duplicate data from previous rows when 
there are no new data needed, thus <code class="language-plaintext highlighter-rouge">Assembler</code> needs to deduplicate (using <code class="language-plaintext highlighter-rouge">equals</code>/<code class="language-plaintext highlighter-rouge">hashCode</code>)
when processing the data to avoid duplicates.</p>

<p>So it is important to write SQL (and database types) such that your data has fields which
allows proper uniqueness detection.</p>

<p>Here’s an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT school.id, school.name, teacher.id, teacher.name, student.name
FROM school
LEFT JOIN teacher WHERE teacher.school_id = school.id
LEFT JOIN student WHERE student.school_id = school.id
</code></pre></div></div>

<p>Note this problematic query only returns the name of the student but not the ID.
If the school has 2 teachers but only one student, we will get a result like this:</p>

<table>
  <thead>
    <tr>
      <th>school.id</th>
      <th>school.name</th>
      <th>teacher.id</th>
      <th>teacher.name</th>
      <th>student.name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sch_id_1</td>
      <td>School 1</td>
      <td>tch_id_1</td>
      <td>Einstein</td>
      <td>Alice</td>
    </tr>
    <tr>
      <td>sch_id_1</td>
      <td>School 1</td>
      <td>tch_id_2</td>
      <td>Curie</td>
      <td>Alice</td>
    </tr>
  </tbody>
</table>

<p>The problem here is that <strong>Alice</strong> has been duplicated by the database engine
to “fill in” the student columns when returning the second <code class="language-plaintext highlighter-rouge">teacher</code> row.
We have no way of knowing whether there are one or two <strong>Alice</strong> in the school.</p>

<p>The simplest way to solve this is to have some sort of identifier (e.g. UUID)
for each entity type. In the above example, we should retrieve <code class="language-plaintext highlighter-rouge">student.id</code> column.</p>

<p>(This doesn’t just apply when using <code class="language-plaintext highlighter-rouge">Assembler</code> - if you’re using SQL then
this is something you need to think about)</p>

<h3 id="parent-types-with-multiple-children">Parent types with multiple children</h3>

<p>Assembler supports having more than one child for parent entities. You can use <code class="language-plaintext highlighter-rouge">make2</code>, <code class="language-plaintext highlighter-rouge">make3</code> etc
depending on how many child entities there are.</p>

<p>For example, <code class="language-plaintext highlighter-rouge">teacher</code> and <code class="language-plaintext highlighter-rouge">student</code> can both be child entities of a <code class="language-plaintext highlighter-rouge">school</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">SchoolMoreInfo</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">teachers</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Teacher</span><span class="o">],</span>
  <span class="n">students</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Student</span><span class="o">]</span>
<span class="o">)</span>

<span class="k">val</span> <span class="nv">schoolMoreInfoDef</span><span class="k">:</span> <span class="kt">ParentDef.Aux</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">SchoolMoreInfo</span>, <span class="kt">DbSchool</span>, <span class="kt">Teacher</span> <span class="kt">::</span> <span class="kt">Student</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> <span class="nv">ParentDef</span><span class="o">.</span><span class="py">make2</span><span class="o">(</span>
  <span class="n">getId</span> <span class="k">=</span> <span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DbSchool</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">d</span><span class="o">.</span><span class="py">id</span><span class="o">,</span>
  <span class="n">constructWithChild</span> <span class="k">=</span> <span class="o">(</span><span class="n">db</span><span class="k">:</span> <span class="kt">DbSchool</span><span class="o">,</span> <span class="n">teachers</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Teacher</span><span class="o">],</span> <span class="n">students</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Student</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">SchoolMoreInfo</span><span class="o">(</span>
    <span class="n">id</span> <span class="k">=</span> <span class="nv">db</span><span class="o">.</span><span class="py">id</span><span class="o">,</span>
    <span class="n">name</span> <span class="k">=</span> <span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">,</span>
    <span class="n">teachers</span> <span class="k">=</span> <span class="n">teachers</span><span class="o">,</span>
    <span class="n">students</span> <span class="k">=</span> <span class="n">students</span>
  <span class="o">)</span>
<span class="o">)</span>

<span class="k">val</span> <span class="nv">schoolMoreInfoAssembler</span><span class="k">:</span> <span class="kt">ParentAssembler</span><span class="o">[</span><span class="kt">cats.Id</span>, <span class="kt">SchoolMoreInfo</span>, <span class="kt">DbSchool</span> <span class="kt">::</span> <span class="kt">DbTeacher</span> <span class="kt">::</span> <span class="kt">DbStudent</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> 
  <span class="nv">schoolMoreInfoDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">(</span><span class="nv">teacherDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">,</span> <span class="nv">studentDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="validated-conversion-to-domain-types">Validated conversion to domain types</h3>

<p>It is common for domain types to have additional constraints representing some domain logic 
(e.g. <code class="language-plaintext highlighter-rouge">name</code> field cannot be empty). <code class="language-plaintext highlighter-rouge">Assembler</code> allows you to handle failures with any failure context
as long as it has a <code class="language-plaintext highlighter-rouge">cats.Applicative</code> instance. (e.g. , <code class="language-plaintext highlighter-rouge">Either</code>, <code class="language-plaintext highlighter-rouge">Validated</code> <code class="language-plaintext highlighter-rouge">Ior</code>)</p>

<p>To create a fallible definition use <code class="language-plaintext highlighter-rouge">makeF</code> instead of <code class="language-plaintext highlighter-rouge">make</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">stricterStudentDef</span><span class="k">:</span> <span class="kt">LeafDef</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">MyError</span>, <span class="kt">*</span><span class="o">]</span>, <span class="kt">Student</span>, <span class="kt">DbStudent</span><span class="o">]</span> <span class="k">=</span> <span class="nv">LeafDef</span><span class="o">.</span><span class="py">makeF</span><span class="o">(</span>
  <span class="o">(</span><span class="n">db</span><span class="k">:</span> <span class="kt">DbStudent</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">.</span><span class="py">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Left</span><span class="o">(</span><span class="nc">MyError</span><span class="o">(</span><span class="s">"Name is empty!"</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">Student</span><span class="o">(</span><span class="n">id</span> <span class="k">=</span> <span class="nv">db</span><span class="o">.</span><span class="py">id</span><span class="o">,</span> <span class="n">name</span> <span class="k">=</span> <span class="nv">db</span><span class="o">.</span><span class="py">name</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">)</span>
</code></pre></div></div>

<p>And our assemble result will be wrapped in our error</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.implicits._</span> <span class="c1">// Provides Monad instance for Either // Provides Monad instance for Either</span>
<span class="k">val</span> <span class="nv">schoolAssembler</span> <span class="k">=</span> <span class="nv">schoolDef</span><span class="o">.</span><span class="py">forEither</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">(</span><span class="nv">stricterStudentDef</span><span class="o">.</span><span class="py">toAssembler</span><span class="o">)</span>
<span class="c1">// schoolAssembler: ParentAssembler[Either[MyError, B], School, DbSchool :: DbStudent :: HNil] = doobieroll.syntax.ToAssemblerSyntax$$anon$2@59c0145f</span>

<span class="nv">schoolAssembler</span><span class="o">.</span><span class="py">assemble</span><span class="o">(</span><span class="n">queryResultsWithBadData</span><span class="o">)</span>
<span class="c1">// res1: Vector[Either[MyError, School]] = Vector(</span>
<span class="c1">//   Right(</span>
<span class="c1">//     School(</span>
<span class="c1">//       51f02985-db87-4350-b557-6d9476e1367f,</span>
<span class="c1">//       "Springfield Elementary School",</span>
<span class="c1">//       Vector(</span>
<span class="c1">//         Student(7158132d-fe59-4ef1-8693-1476a0359aa7, "Bob"),</span>
<span class="c1">//         Student(4386ad3e-a30c-4179-938f-a0ead5bd9b4a, "Lisa")</span>
<span class="c1">//       )</span>
<span class="c1">//     )</span>
<span class="c1">//   ),</span>
<span class="c1">//   Left(MyError("Name is empty!"))</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Some notes for the code snippet:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">schoolDef</code> (from previous section) is an unfallible definition. 
So we need to “lift” its error context to <code class="language-plaintext highlighter-rouge">Either[MyError, *]</code> in order to combine it with
the fallible <code class="language-plaintext highlighter-rouge">stricterStudentDef</code> which can fail</li>
  <li>The results are partial failures - Failures will only bubble up and fail all their parents.
Other entities with valid data are still assembled and accessible. This is useful in many scenarios
where you don’t want one corrupted entity to cause the whole result set to error.</li>
</ul>
</section></div></div></div></div><script src="/doobieroll/highlight/highlight.pack.js"></script><script src="/doobieroll/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'jatcwang/doobieroll'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/doobieroll/js/search.js"></script><script src="/doobieroll/js/docs.js"></script></body></html>