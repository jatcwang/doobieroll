<!DOCTYPE html><html><head><title>DoobieRoll: TableColumns</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jacob Wang" /><meta name="description" content="Collection of utilities for working with Doobie/SQL" /><meta name="og:image" content="/doobieroll/img/poster.png" /><meta name="image" property="og:image" content="/doobieroll/img/poster.png" /><meta name="og:title" content="DoobieRoll: TableColumns" /><meta name="title" property="og:title" content="DoobieRoll: TableColumns" /><meta name="og:site_name" content="DoobieRoll" /><meta name="og:url" content="https://github.com/jatcwang/doobieroll" /><meta name="og:type" content="website" /><meta name="og:description" content="Collection of utilities for working with Doobie/SQL" /><link rel="icon" type="image/png" href="/doobieroll/img/favicon.png" /><meta name="twitter:title" content="DoobieRoll: TableColumns" /><meta name="twitter:image" content="https://jatcwang.github.io/doobieroll/img/poster.png" /><meta name="twitter:description" content="Collection of utilities for working with Doobie/SQL" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobieroll/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobieroll/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobieroll/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobieroll/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobieroll/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobieroll/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobieroll/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobieroll/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobieroll/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobieroll/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobieroll/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobieroll/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobieroll/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobieroll/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobieroll/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobieroll/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobieroll/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobieroll/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobieroll/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobieroll/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobieroll/highlight/styles/a11y-light.css" /><link rel="stylesheet" href="/doobieroll/css/light-style.css" /><link rel="stylesheet" href="/doobieroll/css/main.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/doobieroll/" class="brand"><div class="brand-wrapper"></div><span>DoobieRoll</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/assembler" title="Assembler" class="">Assembler</a></div> <div class="sidebar-nav-item active "><a href="/doobieroll/docs/tablecolumns" title="TableColumns" class="active">TableColumns</a></div> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/snippets" title="Snippets" class="">Snippets</a></div> <div class="sidebar-nav-item  "><a href="/doobieroll/docs/faq" title="FAQ" class="">FAQ</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/jatcwang/doobieroll" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/jatcwang/doobieroll" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="jatcwang" data-github-repo="doobieroll"><div class="content-wrapper"><section><h1 id="tablecolumns">TableColumns</h1>

<h3 id="what-problem-does-it-solve">What problem does it solve?</h3>

<p>In Doobie, we write SQL directly. This results in quite a lot of repetition when we’re specifying columns.
Take this postgres upsert query, for example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.Update</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>

<span class="k">val</span> <span class="nv">q</span><span class="k">:</span> <span class="kt">Update</span><span class="o">[</span><span class="kt">DbCompany</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Update</span><span class="o">[</span><span class="kt">DbCompany</span><span class="o">](</span><span class="s">"""
INSERT INTO company (
  id,
  name,
  phone_number,
  tax_number,
  address
) VALUES (
  ?, ?, ?, ?, ?
)
ON CONFLICT (id) DO UPDATE SET
  id = EXCLUDED.id,
  name = EXCLUDED.name,
  phone_number = EXCLUDED.phone_number,
  tax_number = EXCLUDED.tax_number,
  address = EXCLUDED.address
"""</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DbCompany</span><span class="o">(</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span>
  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">phoneNumber</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">taxNumber</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">address</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre></div></div>

<p>There is a lot of repetition here!</p>

<h1 id="using-tablecolumns">Using TableColumns</h1>

<p>Let’s use <code class="language-plaintext highlighter-rouge">TableColumns</code> to “DRY” up the example above:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobieroll.TableColumns</span>

<span class="k">object</span> <span class="nc">DbCompany</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">columns</span><span class="k">:</span> <span class="kt">TableColumns</span><span class="o">[</span><span class="kt">DbCompany</span><span class="o">]</span>  <span class="k">=</span> <span class="nv">TableColumns</span><span class="o">.</span><span class="py">deriveSnakeCaseTableColumns</span><span class="o">(</span><span class="n">tableName</span> <span class="k">=</span> <span class="s">"company"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">qq</span><span class="k">:</span> <span class="kt">Fragment</span> <span class="o">=</span> <span class="n">fr</span><span class="s">"""
  |INSERT INTO company
  |${DbCompany.columns.listWithParen}
  |VALUES
  |${DbCompany.columns.parameterizedWithParen}
  |ON CONFLICT (id) DO UPDATE SET
  |${updateAllNonKeyColumns(DbCompany.columns)}
"""</span><span class="o">.</span><span class="py">stripMargin</span>
<span class="c1">// qq: Fragment = Fragment("</span>
<span class="c1">// INSERT INTO company</span>
<span class="c1">// (id,name,phone_number,tax_number,address) </span>
<span class="c1">// VALUES</span>
<span class="c1">// (?,?,?,?,?) </span>
<span class="c1">// ON CONFLICT (id) DO UPDATE SET</span>
<span class="c1">// name = EXCLUDED.name, phone_number = EXCLUDED.phone_number, tax_number = EXCLUDED.tax_number, address = EXCLUDED.address </span>
<span class="c1">//  ")</span>

<span class="c1">// You can define your own functions to work with the list of fields!</span>
<span class="k">private</span> <span class="k">def</span> <span class="nf">updateAllNonKeyColumns</span><span class="o">(</span><span class="n">tableColumns</span><span class="k">:</span> <span class="kt">TableColumns</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="k">:</span> <span class="kt">Fragment</span> <span class="o">=</span>
  <span class="nv">Fragment</span><span class="o">.</span><span class="py">const</span><span class="o">(</span>
    <span class="c1">// Assume first field is the primary key, so we don't need to set it</span>
    <span class="nv">tableColumns</span><span class="o">.</span><span class="py">allColumns</span><span class="o">.</span><span class="py">toList</span><span class="o">.</span><span class="py">drop</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">"$c = EXCLUDED.$c"</span><span class="o">).</span><span class="py">mkString</span><span class="o">(</span><span class="s">", "</span><span class="o">)</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>Other than having less boilerplate, the main benefit of using <code class="language-plaintext highlighter-rouge">TableColumns</code> is <strong>consistency</strong>.
Since field names and order are consistent across all use sites, we can avoid out of order fields
causing bugs.</p>

<h2 id="sorting-with-tablecolumns">Sorting with TableColumns</h2>

<p>Usually when sorting a table, the column (or columns) you sort on are not known at compile time. This means you usually need to validate the column name at runtime before using it in the query.
<code class="language-plaintext highlighter-rouge">TableColumns</code> can help in this case as well:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sortCompanies</span><span class="o">(</span><span class="n">sortingField</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">NoSuchField</span>, <span class="kt">Fragment</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">DbCompany</span><span class="o">.</span><span class="py">columns</span><span class="o">.</span><span class="py">fromField</span><span class="o">(</span><span class="n">sortingField</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">sortingColumnFr</span> <span class="k">=&gt;</span>
    <span class="n">fr</span><span class="s">"""
      |SELECT ${DbCompany.columns.listStr} FROM company
      |ORDER BY $sortingColumnFr ASC
    """</span><span class="o">.</span><span class="py">stripMargin</span>
  <span class="o">}</span>
</code></pre></div></div>
</section></div></div></div></div><script src="/doobieroll/highlight/highlight.pack.js"></script><script src="/doobieroll/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'jatcwang/doobieroll'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/doobieroll/js/search.js"></script><script src="/doobieroll/js/docs.js"></script></body></html>